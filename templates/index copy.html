{% extends "layout.html" %}

{% block content %}
<!-- 列表示/非表示メニューのトグルボタン -->
<button id="toggleColumnsMenu">列の表示/非表示</button>

<!-- 列表示/非表示メニュー -->
<div id="columnToggleMenu" style="display: none;">
    <h4>列の表示/非表示</h4>
    {% for index in range(columns|length) %}
    <label>
        <input type="checkbox" class="column-checkbox" data-column="{{ index }}" checked>
        {{ columns[index] }}
    </label>
    {% endfor %}
</div>
<div class="table-container"> <!-- 追加: テーブルを囲む div -->
    <table id="dataTable" class="display">
        <thead>
            <tr>
                <th>年度</th>
                <th>学科</th>
                <th>期間</th>
                <th>授業科目名</th>
                <th>授業担当者</th>
                <th>履修者数</th>
                <th>回答者数</th>
                <th>設問1</th>
                <th>設問2</th>
                <th>設問3</th>
                <th>設問4</th>
                <th>設問5</th>
                <th>設問6</th>
                <th>設問7</th>
                <th>設問8</th>
                <th>設問9</th>
                <th>G</th>
                <th>A</th>
                <th>B</th>
                <th>C</th>
                <th>D</th>
                <th>F</th>
                <th>*</th>
                <th>合格率</th>
                <th>GPA</th>
                <th>GP中央値</th>
            </tr>
            <tr>
                <th>
                    <button class="column-options" data-column="0">・・・</button>
                    <button class="id-options">select</button>
                    <div class="id-filter" style="display: none;">
                        <label><input type="checkbox" value="">すべて</label>
                        {% for item in range(2014,2024) %}
                        <label><input type="checkbox" class="id-checkbox" value="{{ item }}">{{ item }}</label>
                        {% endfor %}
                    </div>
                </th>
                <th>
                    <button class="column-options" data-column="1">・・・</button>
                    <button class="id-options">select</button>
                    <div class="id-filter" style="display: none;">
                        <label><input type="checkbox" value="">すべて</label>
                        {% for item in ["IC","ID","IM","IN","IS","common"] %}
                        <label><input type="checkbox" class="id-checkbox" value="{{ item }}">{{ item }}</label>
                        {% endfor %}
                    </div>
                </th>
                <th>
                    <button class="column-options" data-column="2">・・・</button>
                    <button class="id-options">select</button>
                    <div class="id-filter" style="display: none;">
                        <label><input type="checkbox" value="">すべて</label>
                        {% for item in ["前期","後期"] %}
                        <label><input type="checkbox" class="id-checkbox" value="{{ item }}">{{ item }}</label>
                        {% endfor %}
                    </div>
                </th>
                <th>
                    <button class="column-options" data-column="3">・・・</button>
                    <input type="text" class="age-search" placeholder="" />
                </th>
                <th>
                    <button class="column-options" data-column="4">・・・</button>
                    <input type="text" class="age-search" placeholder="" />
                </th>
                <th>
                    <button class="column-options" data-column="5">・・・</button>
                    <button class="id-options">select</button>
                    <div class="id-filter" style="display: none;">
                        <label><input type="checkbox" value="">すべて</label>
                        {% for item in range(10,201,10) %}
                        <label><input type="checkbox" class="id-checkbox" value="{{ item }}">{{ item }}</label>
                        {% endfor %}
                    </div>
                </th>
                <th>
                    <button class="column-options" data-column="6">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="7">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="8">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="9">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="10">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="11">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="12">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="13">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="14">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="15">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="16">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="17">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="18">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="19">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="20">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="21">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="22">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="23">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="24">・・・</button>
                </th>
                <th>
                    <button class="column-options" data-column="25">・・・</button>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item.year }}</td>
                <td>{{ item.department }}</td>
                <td>{{ item.term }}</td>
                <td>{{ item.subject }}</td>
                <td>{{ item.teacher }}</td>
                <td>{{ item.student_num }}</td>
                <td>{{ item.respondent_num }}</td>
                <td>{{ item.question1 }}</td>
                <td>{{ item.question2 }}</td>
                <td>{{ item.question3 }}</td>
                <td>{{ item.question4 }}</td>
                <td>{{ item.question5 }}</td>
                <td>{{ item.question6 }}</td>
                <td>{{ item.question7 }}</td>
                <td>{{ item.question8 }}</td>
                <td>{{ item.question9 }}</td>
                <td>{{ item.G }}</td>
                <td>{{ item.A }}</td>
                <td>{{ item.B }}</td>
                <td>{{ item.C }}</td>
                <td>{{ item.D }}</td>
                <td>{{ item.F }}</td>
                <td>{{ item.X }}</td>
                <td>{{ item.passrate }}</td>
                <td>{{ item.GPA }}</td>
                <td>{{ item.GPM }}</td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ・・・メニュー -->
<div id="columnMenu"
    style="display: none; position: absolute; background: white; border: 1px solid #ccc; z-index: 1000; padding: 10px;">
    <button class="sort-asc">昇順で並び替え</button>
    <button class="sort-desc">降順で並び替え</button>
    <button class="clear-filter">フィルターをクリア</button>
</div>

<style>
    .table-container {
        margin: 0 20px;
        /* 左右の余白を設定 */
    }

    #columnMenu,
    .id-filter {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
    }

    #columnMenu button,
    .id-filter label {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 8px;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
    }

    #columnMenu button:hover,
    .id-filter label:hover {
        background: #e2e6ea;
    }

    .id-filter {
        padding: 10px;
        background: white;
        position: absolute;
        z-index: 1000;
        display: none;
        /* 初期は非表示 */
    }

    th {
        background-color: #f4f4f4;
        /* ヘッダーの背景色 */
        position: relative;
        /* ポジションを相対的に */
        white-space: nowrap;
        /* 改行を防ぐ */
    }

    .column-toggle {
        margin: 20px;
        /* 上下の余白 */
        background: #f8f9fa;
        /* 背景色 */
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .column-toggle h4 {
        margin-bottom: 10px;
    }

    .column-toggle label {
        display: block;
        margin-bottom: 5px;
    }

    #columnToggleMenu {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 5px;
        z-index: 1000;
    }
</style>

<script>
    function toggleFilter(element) {
        const filterDiv = element.nextElementSibling;
        filterDiv.style.display = filterDiv.style.display === "none" ? "block" : "none";
    }

    function applyFilter() {
        const checkboxes = document.querySelectorAll('.id-checkbox');
        const selectedValues = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value));

        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const studentNum = parseInt(row.cells[5].textContent); // 5番目のセルが履修者数
            if (selectedValues.length === 0 || selectedValues.some(value => studentNum >= value)) {
                row.style.display = ""; // 表示
            } else {
                row.style.display = "none"; // 非表示
            }
        });
    }
    $(document).ready(function () {
        var table = $('#dataTable').DataTable({
            "searching": true,
            "ordering": true,
            "lengthChange": false,
            "paging": false,
            "language": {
                "info": "",
                "emptyTable": "データがありません",
                "zeroRecords": "",
                "infoFiltered": "",
                "infoEmpty": "",
                "lengthMenu": ""
            },
            "columnDefs": [
                { "orderable": false, "targets": "_all" }
            ]
        });

        // 各列のフィルタリング機能
        $('.age-search').on('input', function () {
            const input = $(this);
            const filterValue = parseFloat(input.val()); // 入力値を数値に変換
            const columnIndex = input.closest('th').index(); // 入力ボックスがある列のインデックスを取得
            const rows = $('#dataTable tbody tr'); // テーブルの行を取得

            rows.each(function () {
                const cellValueText = $(this).children('td').eq(columnIndex).text(); // セルの値を取得
                const cellValue = parseFloat(cellValueText); // セルの値を数値に変換

                // セルの値が数値でない場合は、行を表示しない
                if (isNaN(cellValue)) {
                    $(this).hide(); // 数値でない行は非表示
                    return;
                }

                // 同じかそれ以上の値を持つ行のみ表示する
                const isMatch = !isNaN(filterValue) && cellValue >= filterValue;
                $(this).toggle(isMatch);
            });
        });

        // ・・・メニューの表示
        $('.column-options').on('click', function (e) {
            e.stopPropagation();
            var columnIndex = $(this).data('column');
            var menu = $('#columnMenu');
            var buttonPosition = $(this).offset();
            var scrollTop = $(window).scrollTop(); // スクロール位置を考慮

            menu.css({
                position: 'fixed', // 固定位置に変更
                zIndex: 1000,
                top: buttonPosition.top - scrollTop + $(this).outerHeight(), // ボタンの下位置に表示
                left: buttonPosition.left // ボタンの位置に合わせて左側配置
            }).show().data('columnIndex', columnIndex);

            menu.off('click').on('click', 'button', function () {
                switch ($(this).text()) {
                    case '昇順で並び替え':
                        table.order([columnIndex, 'asc']).draw();
                        break;
                    case '降順で並び替え':
                        table.order([columnIndex, 'desc']).draw();
                        break;
                    case 'フィルターをクリア':
                        table.search('').draw();
                        $('input', table.column(columnIndex).header()).val('');
                        $('.id-checkbox').prop('checked', false);
                        table.column(0).search('').draw();
                        break;
                }
            });
        });

        // 列の表示/非表示を切り替える
        $('.column-checkbox').on('change', function () {
            var column = $(this).data('column');
            var isChecked = $(this).is(':checked');
            table.column(column).visible(isChecked);
        });

        // IDフィルターの表示切り替え
        $('.id-options').on('click', function (e) {
            e.stopPropagation();
            var filterMenu = $(this).next('.id-filter');
            filterMenu.toggle();
        });

        // メニューボタンのクリックイベントで表示を切り替え
        $('#toggleColumnsMenu').on('click', function () {
            $('#columnToggleMenu').toggle();
        });

        // メニュー外クリックでメニューを閉じる
        $(document).on('click', function () {
            $('#columnMenu').hide();
            $('.id-filter').hide();
        });

        // メニュー内クリックは閉じないようにする
        $('#columnMenu, .id-filter').on('click', function (e) {
            e.stopPropagation();
        });

        // チェックボックスによるフィルタリング
        $('.id-checkbox').on('change', function () {
            var columnIndex = $(this).closest('th').index(); // チェックボックスの列インデックスを取得
            var checkedValues = $('.id-checkbox:checked').map(function () {
                return this.value;
            }).get(); // チェックされた値を取得

            // フィルタリング条件を設定
            if (checkedValues.length) {
                table.column(columnIndex).search(checkedValues.join('|'), true, false).draw(); // 正規表現で検索
            } else {
                table.column(columnIndex).search('').draw(); // チェックされていない場合は全て表示
            }
        });

        // 「すべて」のチェックボックスをクリックしたときのイベント
        $('.id-filter input[type="checkbox"][value=""]').on('change', function () {
            var isChecked = $(this).is(':checked');
            $(this).closest('.id-filter').find('.id-checkbox').prop('checked', isChecked);
        });

        // 他のチェックボックスがクリックされたとき、「すべて」のチェックボックスを更新
        $('.id-checkbox').on('change', function () {
            var allChecked = $(this).closest('.id-filter').find('.id-checkbox').length ===
                $(this).closest('.id-filter').find('.id-checkbox:checked').length;
            $(this).closest('.id-filter').find('input[type="checkbox"][value=""]').prop('checked', allChecked);
        });

        // 各列の検索ボックスが変更されたときにフィルタリングを行う
        $('.age-search').on('keyup', function () {
            var columnIndex = $(this).closest('th').index(); // 入力ボックスの列インデックスを取得
            var searchValue = $(this).val(); // 入力された値を取得
            table.column(columnIndex).search(searchValue).draw(); // 検索を適用
        });
    });
</script>
{% endblock %}