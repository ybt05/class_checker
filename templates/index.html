{% extends "layout.html" %}

{% block content %}
<table id="dataTable" class="display">
    <thead>
        <tr>
            <th>ID</th>
            <th>名前</th>
            <th>年齢</th>
        </tr>
        <tr>
            <th>
                <button class="id-options">IDフィルター</button>
                <div class="id-filter" style="display: none;">
                    <label><input type="checkbox" value="">すべて</label>
                    {% for item in data %}
                        <label><input type="checkbox" class="id-checkbox" value="{{ item.id }}">{{ item.id }}</label>
                    {% endfor %}
                </div>
            </th>
            <th>
                <button class="column-options" data-column="1">オプション</button>
                <input type="text" placeholder="名前で検索" />
            </th>
            <th>
                <button class="column-options" data-column="2">オプション</button>
                <input type="text" placeholder="年齢で検索" />
            </th>
        </tr>
    </thead>
    <tbody>
        {% for item in data %}
        <tr>
            <td>{{ item.id }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.age }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- オプションメニュー -->
<div id="columnMenu" style="display: none; position: absolute; background: white; border: 1px solid #ccc; z-index: 1000; padding: 10px;">
    <button class="sort-asc">昇順で並び替え</button>
    <button class="sort-desc">降順で並び替え</button>
    <button class="clear-sort">並び替えをクリア</button>
    <button class="clear-filter">フィルターをクリア</button>
    <button class="toggle-hide">この列を非表示</button>
    <button class="toggle-show" style="display: none;">この列を表示</button>
</div>

<style>
    #columnMenu, .id-filter {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
    }
    #columnMenu button, .id-filter label {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 8px;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
    }
    #columnMenu button:hover, .id-filter label:hover {
        background: #e2e6ea;
    }
    .id-filter {
        padding: 10px;
        background: white;
        position: absolute;
        z-index: 1000;
        display: none; /* 初期は非表示 */
    }
</style>

<script>
    $(document).ready(function() {
        var table = $('#dataTable').DataTable({
            "searching": true,
            "ordering": true,
            "lengthChange": false,
            "paging": false,
            "language": {
                "info": "",
                "emptyTable": "データがありません"
            }
        });

        // IDフィルター
        $('.id-checkbox').on('change', function() {
            var selectedIds = $('.id-checkbox:checked').map(function() {
                return this.value;
            }).get();
            var regex = selectedIds.length > 0 ? '^(' + selectedIds.join('|') + ')$' : '';
            table.column(0).search(regex, true, false).draw();
        });

        // 全てのIDを選択するチェックボックス
        $('.id-filter input[type="checkbox"]').first().on('change', function() {
            $('.id-checkbox').prop('checked', this.checked).change();
        });

        // 各検索ボックスに対するイベントハンドラ
        table.columns().every(function() {
            var column = this;
            $('input', this.header()).on('keyup change clear', function() {
                if (column.search() !== this.value) {
                    column.search(this.value).draw();
                }
            });
        });

        // オプションメニュー表示
        $('.column-options').on('click', function(e) {
            var columnIndex = $(this).data('column');
            var menu = $('#columnMenu');

            // メニュー位置を設定
            menu.css({
                top: e.pageY + 'px',
                left: e.pageX + 'px'
            }).show();

            // ボタンの機能設定
            menu.off('click').on('click', 'button', function() {
                switch ($(this).text()) {
                    case '昇順で並び替え':
                        table.order([columnIndex, 'asc']).draw();
                        break;
                    case '降順で並び替え':
                        table.order([columnIndex, 'desc']).draw();
                        break;
                    case '並び替えをクリア':
                        table.order([]).draw();
                        break;
                    case 'フィルターをクリア':
                        column.search('').draw();
                        $('input', table.column(columnIndex).header()).val('');
                        break;
                    case 'この列を非表示':
                        table.column(columnIndex).visible(false);
                        $(this).siblings('.toggle-show').show();
                        $(this).hide();
                        break;
                    case 'この列を表示':
                        table.column(columnIndex).visible(true);
                        $(this).siblings('.toggle-hide').show();
                        $(this).hide();
                        break;
                }
                menu.hide(); // メニューを閉じる
            });
        });

        // IDフィルターのオプションメニュー表示
        $('.id-options').on('click', function(e) {
            e.stopPropagation(); // メニュー外クリックを防ぐ
            $('.id-filter').css({
                top: e.pageY + 'px',
                left: e.pageX + 'px'
            }).toggle(); // メニューの表示切替
        });

        // メニュー外クリックでメニューを隠す
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.column-options').length && !$(e.target).closest('#columnMenu').length && !$(e.target).closest('.id-options').length) {
                $('#columnMenu').hide();
                $('.id-filter').hide(); // IDフィルターを隠す
            }
        });
    });
</script>
{% endblock %}
